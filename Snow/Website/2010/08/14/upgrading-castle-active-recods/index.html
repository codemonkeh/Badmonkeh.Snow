
<!DOCTYPE html>
<!--[if IE 6]>
<html id="ie6" lang="en-US">
<![endif]-->
<!--[if IE 7]>
<html id="ie7" lang="en-US">
<![endif]-->
<!--[if IE 8]>
<html id="ie8" lang="en-US">
<![endif]-->
<!--[if !(IE 6) | !(IE 7) | !(IE 8)  ]><!-->
<html lang="en-US"><!--<![endif]-->
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta name="keywords" content="Christian Froehlich,Christian Fr&#0246;hlich,badmonkeh,software,development,photography,architecture,design patterns,.net,c#,asp.net,sql,html,css" />
    <title>Don't make me think | Ramblings and rants about coding, technology and other stuff…</title>
    <link rel="profile" href="http://gmpg.org/xfn/11">
    <link rel="stylesheet" type="text/css" media="all" href="/css/style.css">
    <link rel="stylesheet" type="text/css" href="/css/font-awesome/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="/css/prettify.css" />
    <!--[if lt IE 9]>
    <script src="/js/html5.js" type="text/javascript"></script>
    <![endif]-->
    <meta name="robots" content="noindex,follow">
    <link rel="alternate" type="application/rss+xml" title="Don't make me think » Feed" href="/feed/">
    <link rel="canonical" href="http://www.badmonkeh.com/2010/08/14/upgrading-castle-active-recods/" />
</head>
<body class="home blog custom-background single-author two-column right-sidebar">
	<div id="page" class="hfeed">
		<header id="branding" role="banner">
			<hgroup>
				<h1 id="site-title"><span><a href="/" title="Don't make me think" rel="home">Don't make me think</a></span></h1>
				<h2 id="site-description">Ramblings and rants about coding, technology and other stuff…</h2>
			</hgroup>
			
			<nav id="access" role="navigation">
				<h3 class="assistive-text">Main menu</h3>
				<div class="skip-link"><a class="assistive-text" href="#content" title="Skip to primary content">Skip to primary content</a></div>
				<div class="skip-link"><a class="assistive-text" href="#secondary" title="Skip to secondary content">Skip to secondary content</a></div>
				<div class="menu">
                    <ul>
                        <li class="current_page_item"><a href="/">Home</a></li>                        
                        <li class="page_item page-item-2"><a href="/category">Categories</a></li>
						<li class="page_item page-item-3"><a href="/tag">Tags</a></li>
                        <li class="page_item page-item-4"><a href="/archive">Archive</a></li>
                        
                        <li class="page_item page-item-6"><a href="/feed.xml">Feed</a></li>
                    </ul>
                </div>
			</nav><!-- #access -->
		</header><!-- #branding -->
        <div id="main">
            <div id="primary" class="site-content">
                <div id="content" role="main">
                  

<article class="post type-post status-publish format-standard hentry">
    <header class="entry-header">
        <h1 class="entry-title">Upgrading Castle Active Records</h1>

        <div class="entry-meta">
            <span class="sep">Posted on </span>14 Aug 2010
        </div><!-- .entry-meta -->
    </header><!-- .entry-header -->

    <div class="entry-content">
        

        <h1>Upgrading Castle Active Records</h1>

<p>From 1.0.3.0 (custom build) to 2.1.2</p>

<p>Downloaded binaries from http://sourceforge.net/projects/castleproject/files/ActiveRecord/2.1/AR%202.1.2.zip/download</p>

<p>I downloaded the binaries, and replaced my reference libraries. To my surprised there were no build errors.</p>

<p>Intrigued, i wandered onto the documentation to see what new features/syntax i could use.
Some notable things i found:</p>

<p>You can now initialise active records by just supplying an assembly, and letting it reflect the types for you.</p>

<pre><code>ActiveRecordsStarter.Initialize(Assembly assembly, IConfigurationSource source)
</code></pre>

<p>Warning: Try to create an Assembly exclusively for ActiveRecord types if you can. This overload will inspect all public types. If there are thousands of types, this can take a considerable amount of time.</p>

<p>Some validation attribute (Validators):</p>

<pre><code>ValidateIsUnique,ValidateRegExp,ValidateEmail,ValidateNonEmpty,ValidateConfirmation
</code></pre>

<p>Generics support:</p>

<p>extend generic base class <code>ActiveRecordBase&lt;T&gt;</code> or for inherent validation support extend <code>ActiveRecordValidationBase&lt;T&gt;</code></p>

<p>Note however that if a record is invalid and you try to save it, it will throw an error. Be sure to check it's IsValid method first.</p>

<p>What doesn't work is my proxy class generation.</p>

<p>So i decided to upgrade to using the NHibernate Proxy Generators (http://sourceforge.net/projects/nhcontrib/files/NHibernate.ProxyGenerators/1.0.0%20Alpha%20564/)</p>

<p>Here's a how to: http://nhforge.org/wikis/howtonh/pre-generate-lazy-loading-proxies.aspx</p>

<p>Unfortunately i had the same issue as last time, that it just does not work for NHibernate 2.2</p>

<p>So i decided to have a play around with the source code a little.</p>

<ul>
<li>Converted the project to VS2010.</li>
<li>Deleted all in libs except for IlMerge.exe</li>
<li>Pasted new AR libs in there</li>
<li>Set all projects target to .NET 3.5</li>
</ul>

<p><code>CastleStaticProxyFactory</code>
 - commented out //using NHibernate.Proxy.Poco.Castle;
 - replaced with NHibernate.ByteCode.Castle
 - changed CastleLazyInitializer to LazyInitializer</p>

<p><code>CastleProxyFactoryFactory</code> : <code>IProxyFactoryFactory</code>
 - added stub method for <code>ProxyValidator</code></p>

<p><code>CastleStaticProxyFactoryFactory</code>
 - added stub method for <code>ProxyValidator</code></p>

<p>Had to add reference to <code>NHibernate.ProxyGenerators.ActiveRecord</code> to the console project</p>

<p>Commented instantiation of <code>SessionFactory</code> - is this the right thing to do?</p>

<p>CastleProxyGenerator
 - commented out //using global::Castle.DynamicProxy;
    + we want to use the new ProxyGenerator v2
 - added using Castle.DynamicProxy;
 - changed ModuleScope to save weakly named assembly only (to avoid an error) - moduleScope.SaveAssembly(false);
    + for some reason a strongly named assembly doesn't contain the factory classes?
 - added compiler reference - references.Add(Assembly.Load("NHibernate.ByteCode.Castle"));, also Castle.ActiveRecord 
 - altered the compilation to add the input assemblies as references to creating the StaticProxyFactory</p>

<p>Removed Post Build Event:</p>

<pre><code>"$(SolutionDir)libs\NHibernateProxyGenerator\NPG.exe" /in:"$(TargetDir)BadMonkeh.DAO.dll" /out:"$(SolutionDir)BadMonkeh.Website\bin\BadMonkeh.DAO.Proxies.dll"
copy "$(TargetPath)" "$(SolutionDir)BadMonkeh.Website\bin\$(TargetFileName)"
</code></pre>

    </div><!-- .entry-content -->   
    
    <footer class="entry-meta">
        <span class="cat-links">
		<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span>
				<a href="/category/software-development" title="Snow.Models.Category" rel="category tag">Software Development</a>,
        </span>
        <span class="sep"> | </span>
        <span class="tag-links">
            <span class="entry-utility-prep entry-utility-prep-tag-links">Tagged</span> 
					<a href="/tag/active-records" title="Snow.Models.Tag" rel="tag">active records</a>,
					<a href="/tag/castle" title="Snow.Models.Tag" rel="tag">castle</a>,
        </span>

        

		<div id="disqus_thread"></div>
<script>
    var reset_disqus = function(){
        DISQUS.reset({
            reload: true,
            config: function () {
                //this.page.identifier = '';
                this.page.url = 'http://www.badmonkeh.com/2010/08/14/upgrading-castle-active-recods/';
                //this.page.title = '';
            }
        });
    };

    var disqus_shortname = 'badmonkehblog';
    var disqus_url = 'http://www.badmonkeh.com/2010/08/14/upgrading-castle-active-recods/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    window.addEventListener('orientationchange', reset_disqus);
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </footer><!-- .entry-meta -->
	
</article>

                </div>
                <!-- #content -->
            </div>
            <!-- #primary .site-content -->
			
            <div id="secondary" class="widget-area" role="complementary">
                <aside id="text-2" class="widget widget_text">
                    <h3 class="widget-title">About me</h3>
                    <div class="textwidget">
                        <a href="/about"><img src="/images/profile/me.jpg" border="0"></a>
                        <p>Hi, i'm Christian Froehlich.</p>
                        <p>
                            I'm a passionate .NET Software Developer with over 10 years of experience in building web application and solving complex problems.
                        </p>
                        <p>I'm also interested in photography, 3D printing, beer and coffee. Check me out ;)</p>
                    </div>
                </aside>
                <aside id="text-3" class="widget widget_text">
                    <div class="textwidget">
                        <a href="https://stackoverflow.com/users/73027/codemonkeh">
                            <img src="https://stackoverflow.com/users/flair/73027.png" width="208" height="58" alt="profile for codemonkeh at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for codemonkeh at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
                        </a>
                    </div>
                </aside>
                <aside id="text-4" class="widget widget_text">
                    <div class="textwidget">
                        <a href="/rss.xml" title="RSS 2.0 Feed"><img src="/images/rss-2x.png" alt="Subscribe via RSS" align="middle" height="46" width="46"><span style="padding-left: 5px;">Subscribe via RSS</span></a><br>
                    </div>
                </aside>
                <aside id="categories-2" class="widget widget_categories">
                    <h3 class="widget-title">Categories</h3>
                    <ul>
                            <li class="cat-item"><a href="/category/photography" title="Snow.Models.Category" rel="tag">Photography</a></li>
                            <li class="cat-item"><a href="/category/software-development" title="Snow.Models.Category" rel="tag">Software Development</a></li>
                    </ul>
                </aside>
                <aside id="recent-posts-2" class="widget widget_recent_entries">
                    <h3 class="widget-title">Recent Posts</h3>
                    <ul>
                            <li><a href="/2018/03/14/converting-mpeg-to-h265/">Converting MPEG to H.265</a></li>
                            <li><a href="/2015/07/07/wix-and-the-tfs-2013-build-server-lets-be-friends/">Wix and the TFS 2013 build server, let's be friends</a></li>
                            <li><a href="/2013/02/12/designdata-makes-your-life-easier/">DesignData makes your life easier</a></li>
                            <li><a href="/2010/09/11/active-records-with-partial-trust-revisited/">Active Records with Partial Trust, Revisited</a></li>
                            <li><a href="/2010/08/14/upgrading-castle-active-recods/">Upgrading Castle Active Records</a></li>
                    </ul>
                </aside>
            </div><!-- #secondary .widget-area -->

        </div>
        <!-- #main -->

		<footer id="colophon" role="contentinfo">
			<div>
			Powered by <a href="https://github.com/codemonkeh/Sandra.Snow" rel="generator">Sandra.Snow</a>. Copyright © 2018 Christian Froehlich. All rights reserved. 
			</div>
		</footer><!-- #colophon -->		
    </div>
	
    <!-- #page .hfeed .site -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src='/js/prettify.js' type='text/javascript'></script>
    
    <script type="text/javascript">
var _gaq = _gaq || [];

_gaq.push(['_setAccount', 'UA-68156920-1']);
_gaq.push(['_trackPageview']);
        
(function () {
    var ga = document.createElement('script');
    ga.type = 'text/javascript';
    ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(ga, s);
})();
</script>
    
    <script type='text/javascript'>
      $(function () {
        $("pre code").parent().each(function () {
          if (!$(this).hasClass("prettyprint")) {
            $(this).addClass("prettyprint");
            a = true
          }
        });

        prettyPrint();
      });
    </script>
</body>
</html>
